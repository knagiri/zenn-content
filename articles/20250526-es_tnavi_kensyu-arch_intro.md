---
title: "鉄ナビ検収のアーキテクチャを紹介します！"
emoji: "🎃"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["typescript", "nestjs", "architecture", "backend"]
published: false
publication_name: "eversteel_tech"
---

## はじめに

こんにちは、株式会社EVERSTEELでエンジニアをしている片桐です。

弊社では鉄スクラップの画像解析を行う「鉄ナビ検収」というプロダクトを開発しており、鉄リサイクルの効率化・品質向上を目指しています。東大発のスタートアップとして、より良いソリューションを追求しながらプロダクト開発を進めています。

この記事では、鉄ナビ検収のバックエンドアーキテクチャについて紹介します。特に以下の内容について紹介します：

- 鉄ナビ検収というプロダクトの概要と技術的背景
- TypeScript + Nest.jsを選択した理由と背景
- システム全体のアーキテクチャ構成とモジュール設計
- チーム拡大に伴う課題と取り組み

スタートアップでのバックエンド開発やアーキテクチャ設計に興味のある方に、EVERSTEELでの開発現場の現状・雰囲気を感じてもらえればと思います。

## 鉄ナビ検収とは

鉄ナビ検収は、鉄スクラップの画像解析を通じて鉄リサイクル業界の効率化・品質向上を目指すプロダクトです。

### プロダクトの背景

鉄リサイクル業界では、持ち込まれた鉄スクラップの品質判定が重要な工程となっています。従来は人の目による判定が中心でしたが、判定者の経験や知識に依存する部分が多く、品質のばらつきや判定時間の課題がありました。

鉄ナビ検収では、AI技術を活用して鉄スクラップの画像から品質を自動で判定することで、これらの課題解決を図っています。

### なぜバックエンドアーキテクチャが重要なのか

鉄ナビ検収のバックエンドは、様々なシステムとの連携が求められる複雑な役割を担っています：

- **カメラシステムとの連携**: 鉄スクラップを撮影するカメラからの画像データを効率的に受信・処理
- **AI解析システムとの連携**: 画像をAIモデルに送信し、解析結果を適切に処理
- **工場基幹システムとの連携**: 各工場で異なる既存の基幹システムとのデータ連携
- **リアルタイム処理**: 判定結果を即座にフロントエンドや外部システムに提供

これらの多様な連携を安定して処理しながら、データの整合性を保ち、システム全体のスケーラビリティを確保することが、バックエンドアーキテクチャ設計の重要な課題となっています。

## 技術スタックの選択理由

鉄ナビ検収のバックエンドでは、**TypeScript** + **Nest.js** をメインの技術スタックとして採用しています。この組み合わせを選択した理由と背景について説明します。

### TypeScript採用の理由

TypeScriptを選択した主な理由は以下の通りです：

**チームの学習曲線と開発効率**
スタートアップという環境で、様々な経験レベルのメンバーが参加する中、型システムによる開発支援が重要な要因でした。また、少人数チームで同じ開発者がフロントエンドとバックエンド両方を担当する際に、技術スタックが統一されていることでの開発効率向上も大きなメリットとなっています。

**型安全性の確保**
複数のシステム間でやり取りされるデータの型を静的に検証することで、実行時エラーを防止できます。特に撮影セッション情報やAI解析結果など、複雑なデータ構造を扱う際に効果的です。

**型による保守性の向上**
型定義による自己文書化効果で、コードの意図が明確になり、新規参画メンバーの学習コストを抑えられます。また、リファクタリング時に型チェックにより変更の影響範囲が明確になり、安全に改修を進められます。

**エコシステムの活用**
Node.jsの豊富なライブラリエコシステムを活用できる点も、開発の効率化に貢献しています。

### Nest.js選択の背景

Nest.jsを採用した理由は以下の通りです：

**複雑なシステム連携への対応しやすさ**
依存性注入により、外部システム（基幹システム、AI解析システム、カメラシステム）との連携部分を疎結合に保ち、テストしやすく変更に強い設計を実現できます。

**標準で提供される機能が充実している**
認証、バリデーション、テストなど、必要な機能が標準で提供されており、ビジネスロジックに集中できます。

**構造化された設計アプローチ**
モジュール分割やデコレータベースの設計により、チーム開発での一貫性を保ちながら、保守しやすいコードベースを構築できます。

### 関数型プログラミングのエッセンスを取り入れた理由

オブジェクト指向のNest.jsフレームワーク上で、関数型プログラミングの考え方を取り入れている理由は、複雑なシステム連携を伴う鉄ナビ検収において、コードの予測可能性とテスタビリティを重視しているためです。

**実際の課題から生まれた選択**
AI解析結果の処理や外部システムとのデータ変換など、エラーが発生しやすい処理が多く、従来のtry-catchベースのエラーハンドリングでは見落としが発生していました。Result型などの明示的なエラーハンドリングにより、この問題の改善を図っています。

これらの技術選択により、複雑なシステム連携を伴う鉄ナビ検収のバックエンドの安定性と保守性の向上を図っています。

## 関数型プログラミングのエッセンス

前章で述べた通り、鉄ナビ検収では関数型プログラミングのエッセンスを取り入れています。複雑なドメインロジックやエラーハンドリングをより安全に、より表現力豊かに実装するための考え方として導入しています。

関数型プログラミングの考え方から特に以下の要素を活用しています：

- **型安全性の強化**: ドメインの概念を型として表現し、誤った使用を防止
- **明示的なエラーハンドリング**: エラーを値として扱い、処理の流れを明確に表現
- **副作用の分離**: ビジネスロジックと外部システムとの連携部分を明確に分離

関数型プログラミングの考え方を取り入れることで、コードの予測可能性が向上し、テストしやすさも改善されています。一方で、学習コストもあるため、チーム全体での理解度向上も並行して進めています。

これらの関数型プログラミングの実践的な適用方法や具体的な実装パターンについては、別の技術記事で詳しく紹介する予定です。

## アーキテクチャの詳細

前章で紹介した技術要素を、実際のシステムアーキテクチャの中でどのように活用しているかを説明します。

### システム構成の概要

鉄ナビ検収のバックエンドは、以下の4つの主要コンポーネントで構成されています：

![アーキテクチャ概要図](/images/es-sw-arch.png)

**cloud_sms**
工場ごとに異なる基幹システムとの連携をサポートします。異なるJSON Schemaを用いた変換ロジックを担い、様々な基幹システムの実装に対応できる柔軟性を提供しています。

**assessment_manager**
基幹システムからの検収情報を処理します。検収データの受信、バリデーション、正規化を行い、後続の処理に必要な形式に整えます。

**capture_session**
検収情報とユーザからの操作を元に、撮影ループを処理します。カメラとの連携やフレームの管理、撮影タイミングの制御を担当します。

**ai_assessment**
撮影ループで解析対象と判定されたフレームのAI解析を実施します。AI解析システムとの連携から結果の処理まで、一連のAI処理フローを管理します。

なお、以前はCloud側に存在していたNCSやFrameClassificationといった機能は、現在工場ローカルでの処理に移行しており、レスポンス性能の向上を図っています。

### クリーンアーキテクチャの採用

鉄ナビ検収では、以下の4層構造を採用しています。

**現在のディレクトリ構造**
```
src/
  ai_assessment/
    application/      # UseCase層
    domain/          # Entity・ビジネスルール層
    infrastructure/  # 外部システム連携層
    presentation/    # API・Controller層
  assessment_manager/
    application/
    domain/
    infrastructure/
    presentation/
  ...
```

各層の責任は以下のように分離されています：

- **Domain層**: ビジネスルールとドメインエンティティ
- **Application層**: ユースケースの実行とドメインサービスの協調
- **Infrastructure層**: データベースや外部APIとの連携
- **Presentation層**: HTTPリクエスト/レスポンスの処理

この構造により、ビジネスロジックを外部の技術的関心事から分離し、テストしやすく保守性の高い設計を実現しています。

### ドメインモデルの型安全性

ドメイン層では、型システムを活用してドメインの概念を安全に表現するように設計しています。例えば、文字列型で表現される様々なIDを、それぞれ異なる型として定義することで、異なる種類のIDを誤って混同することを防いでいます。

また、ドメインエンティティの作成時には、バリデーションロジックを一元化し、データの整合性を確保するようなパターンを採用しています。

このアプローチにより、ドメインオブジェクトの整合性を型レベルで保証し、実行時エラーの削減を図っています。これらの型安全性に関する詳細な実装方法については、今後の技術記事で詳しく紹介する予定です。

### フレームワークとビジネスロジックの分離

Nest.jsのフレームワーク機能（依存性注入、デコレータなど）を活用しながらも、コアなビジネスロジックはフレームワークに依存しない形で実装しています。

```typescript
@Injectable()
export class CreateUserUsecase {
    constructor(
        @Inject(USER_REPOSITORY)
        private readonly repository: UserRepository,
        // 他の依存関係
    ) {}

    exec(args: Args) {
        // フレームワークから独立したビジネスロジックを呼び出し
        return businessLogic(this.repository)(args);
    }
}
```

この設計により、フレームワークの恩恵を受けながらも、ビジネスロジックのテスタビリティと再利用性の確保を目指しています。

### 将来への展望

現在、チーム内でディレクトリ構造の改善について議論を重ねています：

```
src/
  presentation/     # 統合されたAPI層
    auth
    control
    admin
    cloud_sms
  domain/          # ドメイン別の分離
    ai_assessment/
      application/
      domain/
      infrastructure/
    assessment_manager/
```

この構造により、プレゼンテーション層を統合し、各ドメインのビジネスロジックをより明確に分離することを目指しています。

複雑なドメインを扱う鉄ナビ検収において、クリーンアーキテクチャの原則と関数型プログラミングの要素を組み合わせることで、保守性と拡張性の両立を目指しています。特に、型安全性を重視したアプローチにより、チーム開発での品質向上を図っています。

## チーム拡大で見えてきた課題と取り組み

前章まででバックエンドアーキテクチャの技術的な詳細について紹介しましたが、実際のプロダクト開発では技術選択だけでなく、運用面や開発プロセスの課題にも取り組む必要があります。

鉄ナビ検収では、チームの拡大とプロダクトの成長に伴い、新たな課題が見えてきており、現在も継続的な改善を進めています。

### 運用における可視性の課題

**システム状態把握の困難さ**

システムが複雑化する中で、最も重要な課題の一つが「システムの状態を簡単に把握できていない」という点でした。問題が発生した際の原因特定や解決に時間がかかってしまう状況があり、運用効率の改善が急務となっていました。

**オブザーバビリティ強化への段階的アプローチ**

この課題に対して、オブザーバビリティの強化を段階的に進めています：

**第1段階（優先度：高）**
- **ログ改善**: 適切なログレベルと必要な情報を含むログの出力
- **メトリクス収集**: レイテンシ、エラー率、システムメトリクスのCloudWatch可視化
- **アラート最適化**: 対応が必要なもののみをアラート通知するよう調整
- **エラー管理**: Sentryでの既存エラー整理とタスク化、適切な情報の可視化

**第2段階以降（優先度：中〜低）**
- **トレーシング**: パフォーマンスチューニングに必要な情報の取得
- **ダッシュボード**: サービス状態の統合的な把握
- **プロファイリング**: 詳細なパフォーマンス分析

「まず必要なデータを記録し、その後で可視化・分析機能を拡充する」という段階的なアプローチにより、実用性を重視した改善を進めています。

### 事業拡大に伴う新たな挑戦

**工場オンボーディングの簡易化**

鉄ナビ検収の導入工場が増える中で、新規工場でのシステム導入プロセスの簡易化が重要な課題となっています。各工場で異なる基幹システムとの連携をスムーズに行うための仕組み作りを進めています。

**データ整合性とコスト最適化**

システム規模の拡大に伴い、データ整合性の確保とコスト最適化への取り組みも並行して進めています。特に画像データの処理量増加に対応するため、効率的なデータ管理とインフラ利用の最適化を図っています。

### 開発プロセスの進化

**AI活用開発の導入**

開発プロセスにおいても新たな取り組みを開始しており、AI を用いた開発のキックオフを実施しました。コード生成支援や開発効率の向上を目指した実験的な取り組みを進めています。

**Project as Codeと品質向上**

Project as Code の考え方を取り入れ、プロジェクト管理の効率化を図っています。また、システムの複雑化に伴い、テスト実装の重要度がより一層高まっており、テスト戦略の強化に取り組んでいます。

**ドキュメント整備と知識共有**

チーム拡大に伴い、技術的な知識共有やドキュメント整備の重要性も増しています。前章で紹介したような複雑な技術スタックを効果的に活用するため、体系的なドキュメント整理を進めています。

これらの取り組みは、技術的なアーキテクチャ構築と並行して進める必要がある、実際のプロダクト開発の現実的な課題です。各取り組みの詳細な内容や具体的な実装については、今後の技術ブログで個別に紹介予定です。

## まとめ

この記事では、鉄ナビ検収のバックエンドアーキテクチャについて、技術スタックの選択理由から実際の実装、そして現在直面している課題まで幅広く紹介しました。

### 技術選択の背景

TypeScriptとNest.jsの選択は、チームの学習曲線や開発効率を重視した現実的な判断でした。一方で、関数型プログラミングのエッセンスを取り入れることで、複雑なドメインロジックの安全性と保守性の向上を図っています。

### 実践的なアプローチ

Branded-TypeやneverthrowのResult型など、型安全性を重視したアプローチを実際のプロダクト開発に適用し、その効果と課題を体験しています。関数型プログラミングの考え方を段階的に取り入れながら、実用性とのバランスを模索しています。

### 継続的な改善

システムの成長とチーム拡大に伴い、オブザーバビリティの強化や開発プロセスの改善など、新たな課題に対しても段階的なアプローチで取り組んでいます。完璧な解決策を一度に実装するのではなく、実用性を重視した改善を積み重ねています。

### 技術と事業の両立

鉄ナビ検収の開発を通して、技術的な興味と事業的な価値の両立を目指しています。複雑なシステム連携や関数型プログラミングの実践といった技術的挑戦と、工場での実際の運用や事業拡大への対応という現実的な課題を、同時に解決していく開発の現場を紹介できたと思います。

EVERSTEELでのバックエンド開発は、既存の最適解を適用するだけでなく、新しい技術や手法を実際のプロダクトで試行錯誤しながら改善していく、挑戦的で実践的な環境となっています。
